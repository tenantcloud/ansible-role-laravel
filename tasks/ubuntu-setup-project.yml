---
- name: Clone laravel project
  git:
    repo: "{{ project_git }}"
    dest: "{{ work_dir }}"
    version: "{{ project_git_branch }}"
    accept_hostkey: true
  become: true

- name: Change permissions
  file:
    path: "{{ work_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true
    mode: 0644
  become: true

- name: Copy environment file
  copy:
    src: "{{ work_dir }}/.env.example"
    dest: "{{ work_dir }}/.env"
    mode: 0644
    remote_src: true

# yamllint disable
- name: Setup environment file
  lineinfile:
    path: "{{ item.path }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    mode: 0644
  loop:
    - {path: '{{ work_dir }}/.env', regexp: '^APP_URL=', line: 'APP_URL=https://{{ work_domain }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^DB_HOST=', line: 'DB_HOST={{ mysql_host }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^DB_USERNAME=', line: 'DB_USERNAME={{ mysql_db_user }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^DB_PASSWORD=', line: 'DB_PASSWORD={{ mysql_db_user_pass }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^DB_DATABASE=', line: 'DB_DATABASE={{ mysql_database }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_KEY=', line: 'S3_KEY={{ s3_key }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_SECRET_KEY=', line: 'S3_SECRET_KEY={{ s3_secret }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_AWS_URL=', line: 'S3_AWS_URL={{ s3_host }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_BUCKET=', line: 'S3_BUCKET={{ s3_bucket }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_REGION=', line: 'S3_REGION={{ s3_region }}'}
    - {path: '{{ work_dir }}/.env', regexp: '^S3_USE_ENDPOINT=', line: 'S3_USE_ENDPOINT=true'}
# yamllint enable

- name: Install PyMySQL
  pip:
    name: pymysql
    executable: pip3
  become: true

- name: Create database
  mysql_db:
    login_user: "{{ mysql_admin_user }}"
    login_password: "{{ mysql_admin_password }}"
    name: "{{ mysql_database }}"
    state: present

- name: Create database user
  mysql_user:
    login_user: "{{ mysql_admin_user }}"
    login_password: "{{ mysql_admin_password }}"
    name: "{{ mysql_db_user }}"
    password: "{{ mysql_db_user_pass }}"
    priv: '{{ mysql_database }}.*:ALL'
    state: present

- name: Ensure Nodejs dependencies are present.
  apt:
    name:
      - apt-transport-https
      - gnupg2
    state: present
  become: true

- name: Add NodeSource apt key.
  apt_key:
    url: "{{ node_apt_key }}"
    id: "68576280"
    state: present
  become: true

- name: Add NodeSource repositories for Node.js.
  apt_repository:
    repo: "{{ item }}"
    state: present
  loop:
    - "{{ node_source_repo_1 }}"
    - "{{ node_source_repo_2 }}"
  become: true
  register: node_repo

- name: Update apt cache if repo was added.
  apt: update_cache=yes
  when: node_repo.changed
  tags:
    - skip_ansible_lint
  become: true

- name: Ensure Node.js and npm are installed.
  apt:
    name: "nodejs={{ nodejs_version|regex_replace('x', '') }}*"
    state: present
  become: true

- name: Copy nginx config file
  template:
    src: "vhost.conf.j2"
    dest: "/etc/nginx/sites-enabled/{{ work_domain }}.conf"
    mode: 0644
  notify: Restart Nginx
  become: true

- name: Create log directory
  file:
    path: "{{ ansible_env.HOME }}/.log"
    state: directory
    mode: "0755"
